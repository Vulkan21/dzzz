name: Deploy Static Site to Play-with-Docker

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      play_with_docker_url:
        description: 'Play-with-Docker instance URL'
        required: true
        default: 'https://labs.play-with-docker.com'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Build Docker image
      run: |
        docker build -t static-website:latest .
        
    - name: Test Docker container locally
      run: |
        docker run -d --name test-container -p 8080:80 static-website:latest
        sleep 10
        curl -f http://localhost:8080 || exit 1
        docker stop test-container
        docker rm test-container
        
    - name: Save Docker image as tar
      run: |
        docker save static-website:latest > static-website.tar
        
    - name: Create deployment package
      run: |
        mkdir -p deployment-package
        cp docker-compose.yml deployment-package/
        cp static-website.tar deployment-package/
        
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð´Ð»Ñ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ð¾Ð±Ñ€Ð°Ð·Ð°
        cat > deployment-package/deploy.sh << 'EOF'
        #!/bin/bash
        echo "ðŸš€ Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Docker Ð¾Ð±Ñ€Ð°Ð·..."
        docker load < static-website.tar
        
        echo "ðŸ“¦ Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€ Ñ Ð¿Ð¾Ð¼Ð¾Ñ‰ÑŒÑŽ docker-compose..."
        docker-compose up -d
        
        echo "âœ… Ð Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ðµ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¾!"
        echo "ðŸŒ Ð¡Ð°Ð¹Ñ‚ Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ð¿Ð¾ Ð°Ð´Ñ€ÐµÑÑƒ: http://localhost"
        
        # ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð°
        echo "ðŸ“Š Ð¡Ñ‚Ð°Ñ‚ÑƒÑ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð°:"
        docker-compose ps
        
        # ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ð»Ð¾Ð³Ð¸
        echo "ðŸ“‹ ÐŸÐ¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ Ð»Ð¾Ð³Ð¸:"
        docker-compose logs --tail=20
        EOF
        
        chmod +x deployment-package/deploy.sh
        
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ README Ð´Ð»Ñ Ñ€Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ñ
        cat > deployment-package/README.md << 'EOF'
        # Ð Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ðµ ÑÑ‚Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ð³Ð¾ ÑÐ°Ð¹Ñ‚Ð° Ð½Ð° Play-with-Docker
        
        ## Ð‘Ñ‹ÑÑ‚Ñ€Ñ‹Ð¹ ÑÑ‚Ð°Ñ€Ñ‚
        
        1. Ð¡ÐºÐ¾Ð¿Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ Ð²ÑÐµ Ñ„Ð°Ð¹Ð»Ñ‹ Ð¸Ð· ÑÑ‚Ð¾Ð¹ Ð¿Ð°Ð¿ÐºÐ¸ Ð½Ð° Ð²Ð°Ñˆ Play-with-Docker Ð¸Ð½ÑÑ‚Ð°Ð½Ñ
        2. Ð’Ñ‹Ð¿Ð¾Ð»Ð½Ð¸Ñ‚Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñƒ: `./deploy.sh`
        
        ## ÐÐ»ÑŒÑ‚ÐµÑ€Ð½Ð°Ñ‚Ð¸Ð²Ð½Ñ‹Ð¹ ÑÐ¿Ð¾ÑÐ¾Ð±
        
        ```bash
        # Ð—Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ Ð¾Ð±Ñ€Ð°Ð·
        docker load < static-website.tar
        
        # Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€
        docker-compose up -d
        ```
        
        ## ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹
        
        ```bash
        # ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ ÑÑ‚Ð°Ñ‚ÑƒÑ
        docker-compose ps
        
        # ÐŸÐ¾ÑÐ¼Ð¾Ñ‚Ñ€ÐµÑ‚ÑŒ Ð»Ð¾Ð³Ð¸
        docker-compose logs
        
        # ÐžÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ
        docker-compose down
        ```
        
        Ð¡Ð°Ð¹Ñ‚ Ð±ÑƒÐ´ÐµÑ‚ Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ð¿Ð¾ Ð°Ð´Ñ€ÐµÑÑƒ: http://localhost
        EOF
        
    - name: Create archive for Play-with-Docker
      run: |
        cd deployment-package
        tar -czf ../play-with-docker-deployment.tar.gz .
        cd ..
        
    - name: Upload deployment artifacts
      uses: actions/upload-artifact@v4
      with:
        name: play-with-docker-deployment
        path: |
          play-with-docker-deployment.tar.gz
          deployment-package/
        retention-days: 30
        
    - name: Generate deployment instructions
      run: |
        cat > DEPLOYMENT_INSTRUCTIONS.md << 'EOF'
        # ðŸš€ Ð˜Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸Ð¸ Ð¿Ð¾ Ñ€Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸ÑŽ Ð½Ð° Play-with-Docker
        
        ## Ð¨Ð°Ð³ 1: Ð¡ÐºÐ°Ñ‡Ð°Ð¹Ñ‚Ðµ Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ñ‹
        
        1. ÐŸÐµÑ€ÐµÐ¹Ð´Ð¸Ñ‚Ðµ Ð²Ð¾ Ð²ÐºÐ»Ð°Ð´ÐºÑƒ "Actions" Ð² Ð²Ð°ÑˆÐµÐ¼ GitHub Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¸
        2. ÐÐ°Ð¹Ð´Ð¸Ñ‚Ðµ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ð¹ ÑƒÑÐ¿ÐµÑˆÐ½Ñ‹Ð¹ workflow run
        3. Ð¡ÐºÐ°Ñ‡Ð°Ð¹Ñ‚Ðµ Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚ `play-with-docker-deployment`
        
        ## Ð¨Ð°Ð³ 2: ÐŸÐ¾Ð´Ð³Ð¾Ñ‚Ð¾Ð²ÑŒÑ‚Ðµ Play-with-Docker
        
        1. ÐžÑ‚ÐºÑ€Ð¾Ð¹Ñ‚Ðµ https://labs.play-with-docker.com
        2. Ð’Ð¾Ð¹Ð´Ð¸Ñ‚Ðµ Ð² ÑÐ¸ÑÑ‚ÐµÐ¼Ñƒ (Ñ‚Ñ€ÐµÐ±ÑƒÐµÑ‚ÑÑ Docker Hub Ð°ÐºÐºÐ°ÑƒÐ½Ñ‚)
        3. ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ "Start" Ð´Ð»Ñ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ Ð½Ð¾Ð²Ð¾Ð¹ ÑÐµÑÑÐ¸Ð¸
        4. ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ "+ ADD NEW INSTANCE" Ð´Ð»Ñ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ Ð½Ð¾Ð²Ð¾Ð³Ð¾ ÑƒÐ·Ð»Ð°
        
        ## Ð¨Ð°Ð³ 3: Ð—Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚Ðµ Ñ„Ð°Ð¹Ð»Ñ‹
        
        Ð’ Ñ‚ÐµÑ€Ð¼Ð¸Ð½Ð°Ð»Ðµ Play-with-Docker Ð²Ñ‹Ð¿Ð¾Ð»Ð½Ð¸Ñ‚Ðµ:
        
        ```bash
        # Ð¡Ð¾Ð·Ð´Ð°Ð¹Ñ‚Ðµ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð´Ð»Ñ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
        mkdir static-website && cd static-website
        
        # Ð—Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚Ðµ Ð°Ñ€Ñ…Ð¸Ð² (Ð·Ð°Ð¼ÐµÐ½Ð¸Ñ‚Ðµ URL Ð½Ð° Ð²Ð°Ñˆ)
        wget https://github.com/YOUR_USERNAME/YOUR_REPO/releases/download/latest/play-with-docker-deployment.tar.gz
        
        # Ð˜Ð»Ð¸ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ curl
        curl -L -o play-with-docker-deployment.tar.gz "DIRECT_DOWNLOAD_LINK"
        
        # Ð Ð°ÑÐ¿Ð°ÐºÑƒÐ¹Ñ‚Ðµ Ð°Ñ€Ñ…Ð¸Ð²
        tar -xzf play-with-docker-deployment.tar.gz
        ```
        
        ## Ð¨Ð°Ð³ 4: Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ ÑÐ°Ð¹Ñ‚
        
        ```bash
        # Ð’Ñ‹Ð¿Ð¾Ð»Ð½Ð¸Ñ‚Ðµ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ñ€Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ñ
        ./deploy.sh
        
        # Ð˜Ð»Ð¸ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ:
        docker load < static-website.tar
        docker-compose up -d
        ```
        
        ## Ð¨Ð°Ð³ 5: ÐžÑ‚ÐºÑ€Ð¾Ð¹Ñ‚Ðµ ÑÐ°Ð¹Ñ‚
        
        1. ÐŸÐ¾ÑÐ»Ðµ Ð·Ð°Ð¿ÑƒÑÐºÐ° ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð°, Ð² Play-with-Docker Ð¿Ð¾ÑÐ²Ð¸Ñ‚ÑÑ ÐºÐ½Ð¾Ð¿ÐºÐ° Ñ Ð¿Ð¾Ñ€Ñ‚Ð¾Ð¼ "80"
        2. ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ Ð½Ð° Ð½ÐµÑ‘ Ð´Ð»Ñ Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚Ð¸Ñ ÑÐ°Ð¹Ñ‚Ð° Ð² Ð½Ð¾Ð²Ð¾Ð¹ Ð²ÐºÐ»Ð°Ð´ÐºÐµ
        3. Ð˜Ð»Ð¸ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ Ð¿Ñ€ÑÐ¼ÑƒÑŽ ÑÑÑ‹Ð»ÐºÑƒ, ÐºÐ¾Ñ‚Ð¾Ñ€Ð°Ñ Ð¿Ð¾ÑÐ²Ð¸Ñ‚ÑÑ Ð² Ð¸Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹ÑÐµ
        
        ## ÐŸÐ¾Ð»ÐµÐ·Ð½Ñ‹Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹
        
        ```bash
        # ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ ÑÑ‚Ð°Ñ‚ÑƒÑ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð°
        docker-compose ps
        
        # ÐŸÐ¾ÑÐ¼Ð¾Ñ‚Ñ€ÐµÑ‚ÑŒ Ð»Ð¾Ð³Ð¸
        docker-compose logs
        
        # ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ
        docker-compose restart
        
        # ÐžÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ
        docker-compose down
        
        # ÐŸÐ¾ÑÐ¼Ð¾Ñ‚Ñ€ÐµÑ‚ÑŒ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ Ñ€ÐµÑÑƒÑ€ÑÐ¾Ð²
        docker stats
        ```
        
        ## Ð£ÑÑ‚Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼
        
        - Ð•ÑÐ»Ð¸ Ð¿Ð¾Ñ€Ñ‚ 80 Ð·Ð°Ð½ÑÑ‚, Ð¸Ð·Ð¼ÐµÐ½Ð¸Ñ‚Ðµ Ð¿Ð¾Ñ€Ñ‚ Ð² docker-compose.yml (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, Ð½Ð° 8080:80)
        - Ð£Ð±ÐµÐ´Ð¸Ñ‚ÐµÑÑŒ, Ñ‡Ñ‚Ð¾ Docker Ð¾Ð±Ñ€Ð°Ð· Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½: `docker images`
        - ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ð»Ð¾Ð³Ð¸ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð°: `docker-compose logs`
        
        EOF
        
    - name: Upload deployment instructions
      uses: actions/upload-artifact@v4
      with:
        name: deployment-instructions
        path: DEPLOYMENT_INSTRUCTIONS.md
        retention-days: 30
        
    - name: Display success message
      run: |
        echo "âœ… Ð¡Ð±Ð¾Ñ€ÐºÐ° Ð¸ Ð¿Ð¾Ð´Ð³Ð¾Ñ‚Ð¾Ð²ÐºÐ° Ðº Ñ€Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸ÑŽ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð° ÑƒÑÐ¿ÐµÑˆÐ½Ð¾!"
        echo ""
        echo "ðŸ“¦ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ñ‹:"
        echo "  - play-with-docker-deployment.tar.gz (Ð°Ñ€Ñ…Ð¸Ð² Ð´Ð»Ñ Ñ€Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ñ)"
        echo "  - DEPLOYMENT_INSTRUCTIONS.md (Ð¸Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸Ð¸ Ð¿Ð¾ Ñ€Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸ÑŽ)"
        echo ""
        echo "ðŸš€ Ð¡Ð»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ðµ ÑˆÐ°Ð³Ð¸:"
        echo "  1. Ð¡ÐºÐ°Ñ‡Ð°Ð¹Ñ‚Ðµ Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ñ‹ Ð¸Ð· Ñ€Ð°Ð·Ð´ÐµÐ»Ð° Actions"
        echo "  2. Ð—Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚Ðµ Ð¸Ñ… Ð½Ð° Play-with-Docker"
        echo "  3. Ð’Ñ‹Ð¿Ð¾Ð»Ð½Ð¸Ñ‚Ðµ ./deploy.sh"
        echo ""
        echo "ðŸŒ ÐŸÐ¾ÑÐ»Ðµ Ñ€Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ñ ÑÐ°Ð¹Ñ‚ Ð±ÑƒÐ´ÐµÑ‚ Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ð¿Ð¾ Ð¿Ð¾Ñ€Ñ‚Ñƒ 80"
